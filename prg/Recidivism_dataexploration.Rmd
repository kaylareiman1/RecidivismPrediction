---
title: "Recidivism_dataexploration"
author: "Group12"
date: "5/2/2020"
output: html_document
---

```{r, message = FALSE}
#Suppressing warnings about libraries
#Import  libraries (currently overdoing it)
library(tidyverse)    
library(ggplot2)      # graphics library
library(gridExtra)    # For displaying graphs side-by-side
library(knitr)        # contains knitting control
library(tree)         # For the tree-fitting 'tree' function
library(randomForest) # For random forests
library(rpart)        # For nicer tree fitting
library(partykit)     # For nicer tree plotting
library(boot)         # For cv.glm
library(leaps)        # needed for regsubsets (though maybe not relevant b/c our outcome vars are binary)


#Format numbers so that they are not in scientific notation.
options(scipen = 4)

###################################
# Read in all ProPublica datasets #
###################################
compas.scores.raw <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\compas-scores-raw.csv")

compas.scores <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\compas-scores.csv")

compas.scores.two.years <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\compas-scores-two-years.csv")

compas.scores.two.years.violent <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\compas-scores-two-years-violent.csv")

cox.parsed <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\cox-parsed.csv")

cox.violent.parsed <- read_csv("C:\\Users\\uukay\\OneDrive\\Documents\\mini4\\Data Mining\\Final project\\RecidivismPrediction\\datasets\\cox-violent-parsed.csv")

#Next step 1 (low LOE): Somebody fix so the file paths aren't just for my local directories. Here are three options in order of how ideal they would be:
#   The propublica github files
#   My forked version of the propublica github files:  https://github.com/kaylareiman1/compas-analysis
#   Our copied and pasted version of the propublica github files: https://github.com/kaylareiman1/RecidivismPrediction/tree/master/datasets

####################################
# Adapt ProPublica's Data Cleaning #
####################################
#Note: This code is copied directly from ProPublica. Here is why they dropped data:
      # - dropped if charge date not w/in 30 days  
      # - Coded the recidivist flag -- is_recid -- to be -1 if could not find a compas case at all.  
      # - Ordinary traffic offenses removed  
      # - Filtered the underlying data from Broward county to include:  
      #   + people who had either recidivated in two years  
      #   + had at least two years outside of a correctional facility.  

#Unlike ProPublica, we won't be dropping any attributes because that may bias our model.
### All recidivism ###

#Dropping bad data
nrow(compas.scores.two.years)
recid.all <-compas.scores.two.years %>% 
        filter(days_b_screening_arrest <= 30) %>%
        filter(days_b_screening_arrest >= -30) %>%
        filter(is_recid != -1) %>%
        filter(c_charge_degree != "O") %>%
        filter(score_text != 'N/A')
nrow(recid.all)

#Recoding variables
recid.all$length_of_stay <- as.numeric(as.Date(recid.all$c_jail_out) - as.Date(recid.all$c_jail_in))
recid.all <- mutate(recid.all, crime_factor = factor(c_charge_degree)) %>%
      mutate(age_factor = as.factor(age_cat)) %>%
      within(age_factor <- relevel(age_factor, ref = 1)) %>%
      mutate(race_factor = factor(race)) %>%
      within(race_factor <- relevel(race_factor, ref = 3)) %>%
      mutate(gender_factor = factor(sex, labels= c("Female","Male"))) %>%
      within(gender_factor <- relevel(gender_factor, ref = 2)) %>%
      mutate(score_factor = factor(score_text != "Low", labels = c("LowScore","HighScore")))


### Violent recidivism ###
#Dropping bad data
nrow(compas.scores.two.years.violent)
recid.vio <- compas.scores.two.years.violent %>% 
        filter(days_b_screening_arrest <= 30) %>%
        filter(days_b_screening_arrest >= -30) %>% 
        filter(is_recid != -1) %>%
        filter(c_charge_degree != "O") %>%
        filter(v_score_text != 'N/A')
nrow(recid.vio)

#Recoding variables
#KR note: Why is race coded differently? Is there a mistake?
recid.vio <- mutate(recid.vio, crime_factor = factor(c_charge_degree)) %>%
      mutate(age_factor = as.factor(age_cat)) %>%
      within(age_factor <- relevel(age_factor, ref = 1)) %>%
      mutate(race_factor = factor(race,
                                  labels = c("African-American", 
                                             "Asian",
                                             "Caucasian", 
                                             "Hispanic", 
                                             "Native American",
                                             "Other"))) %>%
      within(race_factor <- relevel(race_factor, ref = 3)) %>%
      mutate(gender_factor = factor(sex, labels= c("Female","Male"))) %>%
      within(gender_factor <- relevel(gender_factor, ref = 2)) %>%
      mutate(score_factor = factor(v_score_text != "Low", labels = c("LowScore","HighScore")))
```

#Notes based on the ProPublica work
**Resources**
- [main program](https://github.com/propublica/compas-analysis/blob/master/Compas%20Analysis.ipynb) 
- [methodology write-up](https://www.propublica.org/article/how-we-analyzed-the-compas-recidivism-algorithm)  

**Notes from Compas Analysis.ipynb**
* Choosing this program
  + This was the most recently updated program.     
  + It also links to the methodology report, which makes me think it's most relevant.  
  
* Oddly, the code is in R, even though it's a Python Jupyter Notebook. We should apply the same data cleaning steps.
  
* First dataset read in is **compas-scores-two-years.csv** with 7214 rows.   
  -**Cleaning:** They then clearned it in the following ways for 6172 rows:  
      - dropped if charge date not w/in 30 days  
      - Coded the recidivist flag -- is_recid -- to be -1 if could not find a compas case at all.  
      - Ordinary traffic offenses removed  
      - Filtered the underlying data from Broward county to include:  
        + people who had either recidivated in two years  
        + had at least two years outside of a correctional facility.    
  -**Variables:** Only included these vars: raw_data, age, c_charge_degree, race, age_cat, score_text, sex, priors_count, days_b_screening_arrest, decile_score, is_recid, two_year_recid, c_jail_in, c_jail_out  
    + crime_factor = factor(c_charge_degree); Seems to be something about type of crime?  
    + decile_score = factor(score_text != "Low", labels = c("LowScore","HighScore"))  
    + two_year_recid is the var they use for analysis  
  -**Analysis** Ran racial bias analysis  
    + Function: `glm(formula = decile_score ~ gender_factor + age_factor + race_factor + priors_count + crime_factor + two_year_recid, family = "binomial", data = df)`  
    + Using two_year_recid to predict decile_score. Seems backwards?  

* Second dataset read in is **compas-scores-two-years-violent.csv** with 4743 rows. After cleaning, it only had 4020 rows.
  -Model: glm(decile_score ~ gender_factor + age_factor + race_factor + priors_count + crime_factor + two_year_recid, family="binomial", data=df

* Third dataset is **cox-parsed.csv** with 13,334 rows originally and 10314 after filtering.
  + used function coxph to assess "whether Compas scores do an accurate job of deciding whether an offender is Low, Medium or High risk".
  
* Switched to Python to assess direction of racial bias using both **cox-parsed.csv** and fourth dataset of **cox-violent-parsed.csv**.
#Columns

```{r, warning = FALSE, message = FALSE}
colnames.all <- colnames(recid.all)
colnames.vio <- colnames(recid.vio)

#Print full list of columns
colnames.all


#Print columns that differ
colnames.vio[(colnames.vio != colnames.all)]
colnames.all[(colnames.vio != colnames.all)]

#Check how the recidivism variables relate
kable(recid.all %>%
  group_by (two_year_recid, is_recid, is_violent_recid, violent_recid) %>%
  summarize(count = n()), caption = "How variables relate in recid.all dataset")

kable(recid.vio %>%
  group_by (two_year_recid, two_year_recid_1, is_recid, is_violent_recid, violent_recid) %>%
  summarize(count = n()), caption = "How variables relate in recid.vio dataset")
```

# Crime Prediction Metrics
```{r, warning = FALSE, message = FALSE}
#Propublica relevant vars: `glm(formula = score_factor ~ gender_factor + age_factor + race_factor + priors_count + crime_factor + two_year_recid, family = "binomial", data = df)`  

ranking.all <- ggplot(recid.all, aes(x=decile_score, fill = score_text))+
  geom_bar(stat = "count", bin = 1) +
  ggtitle("Prediction Metrics\nAll data") + 
  xlab("Prediction") + 
  guides(fill = FALSE) + 
  ylab("Number of people") 

ranking.vio <- ggplot(recid.vio, aes(x=v_decile_score, fill = v_score_text))+
  geom_bar(stat = "count", bin = 1) +
  ggtitle("Prediction Metrics\nViolence data") + 
  xlab("Prediction")+ 
  ylab(NULL)

grid.arrange(ranking.all, ranking.vio, ncol = 2)

```

# Demographics -- example analysis with gender (can copy/paste for other)
```{r, warning = FALSE, message = FALSE}
#Propublica relevant vars: `glm(formula = score_factor ~ gender_factor + age_factor + race_factor + priors_count + crime_factor + two_year_recid, family = "binomial", data = df)`  

### SEX ###

##############
# Univariate #
##############
gender_factor.uni.all <- ggplot(recid.all, aes(x=gender_factor, fill = sex))
gender_factor.uni.all + 
  geom_bar(stat = "count", na.rm = F) + 
  ggtitle("Univariate Gender Breakdown") + 
  guides(fill = FALSE) + 
  xlab("gender") + 
  ylab("Number of Respondents")

#############################
# Bivariate w/ decile score #
#############################
#All
sex.bi.conf.all <- recid.all %>%
  group_by(sex) %>%
  summarize(Avgdecile_score = mean(decile_score),
            upper = t.test(decile_score)$conf.int[1],
            lower = t.test(decile_score)$conf.int[2])

sex.bi.all.dec <- ggplot(data = sex.bi.conf.all, aes(x = sex, y = Avgdecile_score,fill = sex)) +  geom_bar(stat = "identity") +
  xlab("sex") + 
  ylab("Average prediction ($)") +
  ggtitle("Average risk score: \nAny Recidivism") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12))

#Violent
sex.bi.conf.vio <- recid.vio %>%
  group_by(sex) %>%
  summarize(Avgdecile_score = mean(v_decile_score),
            upper = t.test(v_decile_score)$conf.int[1],
            lower = t.test(v_decile_score)$conf.int[2])

sex.bi.vio.dec <- ggplot(data = sex.bi.conf.vio, aes(x = sex, y = Avgdecile_score,fill = sex)) +
  geom_bar(stat = "identity") +
  xlab("sex") + 
  ylab("Average prediction ($)") +
  ggtitle("Average risk score: \nViolent Recidivism") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12))

######################
# Bivariate w/ recid #
######################
#All
sex.bi.conf.all <- recid.all %>%
  group_by(sex) %>%
  summarize(Avgtwo_year_recid = mean(two_year_recid),
            upper = t.test(two_year_recid)$conf.int[1],
            lower = t.test(two_year_recid)$conf.int[2])

sex.bi.all.recid <- ggplot(data = sex.bi.conf.all, aes(x = sex, y = Avgtwo_year_recid,fill = sex)) +
  geom_bar(stat = "identity") +
  xlab("sex") + 
  ylab("Average actual rate") +
  ggtitle("Average 2-year Follow-Up: \nAny Recidivism") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12))

#Violent
sex.bi.conf.vio <- recid.vio %>%
  group_by(sex) %>%
  summarize(Avgtwo_year_recid = mean(two_year_recid),
            upper = t.test(two_year_recid)$conf.int[1],
            lower = t.test(two_year_recid)$conf.int[2])

sex.bi.vio.recid <- ggplot(data = sex.bi.conf.vio, aes(x = sex, y = Avgtwo_year_recid,fill = sex)) +
  geom_bar(stat = "identity") +
  xlab("sex") + 
  ylab("Average actual rate") +
  ggtitle("Average 2-year Follow-Up: \nViolent Recidivism") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12))

grid.arrange(sex.bi.all.dec, sex.bi.all.recid, ncol = 2)
grid.arrange(sex.bi.vio.dec, sex.bi.vio.recid, ncol = 2)


```